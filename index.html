<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Assist</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
  :root{--bg:#ffffff;--text:#111827;--muted:#6b7280;--border:#e5e7eb;--card:#ffffff;--primary:#2563eb;--primary-ink:#ffffff;--hover:#f3f4f6}
  @media (prefers-color-scheme: dark){
    :root{--bg:#0b1220;--text:#e5e7eb;--muted:#9ca3af;--border:#1f2937;--card:#111827;--hover:#111827}
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;padding:24px;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5}
  header{position:sticky;top:0;background:rgba(255,255,255,.7);backdrop-filter:saturate(180%) blur(12px);border-bottom:1px solid var(--border);padding:12px 24px;margin:-24px -24px 24px}
  @media (prefers-color-scheme: dark){header{background:rgba(11,18,32,.6)}}
  header nav{display:flex;gap:12px;align-items:center}
  header strong{margin-right:6px}
  nav a{display:inline-block;padding:8px 12px;border:1px solid transparent;border-radius:999px;text-decoration:none;color:var(--text)}
  nav a:hover{background:var(--hover)}
  nav a.active{background:var(--primary);color:var(--primary-ink);border-color:var(--primary)}
  main{max-width:800px;margin:0 auto}
  h1,h2{margin:0 0 12px}
  .muted{color:var(--muted)}
  .btn,button{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer}
  .btn:hover,button:hover{background:var(--hover)}
  input[type=text]{flex:1;min-width:0;padding:10px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text)}
  form{display:flex;gap:8px;margin:12px 0 16px}
  ul{list-style:none;padding:0;margin:0}
  li{padding:12px;border:1px solid var(--border);border-radius:12px;margin-bottom:8px;background:var(--card);box-shadow:0 1px 2px rgba(0,0,0,.03)}
  a:focus,button:focus,input:focus{outline:2px solid var(--primary);outline-offset:2px}
  footer{margin-top:40px;color:var(--muted);font-size:14px}
</style>
</head>
<body>
  <header>
    <strong>Assist</strong>
    <nav>
      <a href="#home" id="link-home">Home</a>
      <a href="#messages" id="link-messages">Messages</a>
      <a href="#account" id="link-account">Account</a>
    </nav>
  </header>

  <main>
    <section id="home" data-page>
      <h1 id="greet">Hello, Steve!</h1>
      <p id="from-db" class="muted">Loading from Supabase…</p>
      <button id="btn" class="btn">Change greeting</button>
    </section>

    <section id="messages" data-page hidden>
      <h2>Messages</h2>
      <form id="msg-form" autocomplete="off">
        <input id="msg-input" type="text" placeholder="Write a message…" required />
        <button class="btn" type="submit">Post</button>
      </form>
      <ul id="msg-list">
        <li class="muted">Loading messages…</li>
      </ul>
      <p class="muted"><small>Realtime on: new messages appear instantly.</small></p>
    </section>

    <section id="account" data-page hidden>
      <h2>Account</h2>
      <p class="muted">Auth coming later. For now this is open demo data.</p>
    </section>
  </main>

  <script>
    // Small router: show section that matches the hash (#home, #messages, #account)
    function showPage() {
      const hash = location.hash.replace('#', '') || 'home';
      document.querySelectorAll('[data-page]').forEach(sec => { sec.hidden = sec.id !== hash; });
      document.querySelectorAll('nav a').forEach(a => { a.classList.toggle('active', a.getAttribute('href') === '#' + hash); });
    }
    window.addEventListener('hashchange', showPage);
    showPage();

    // Tiny interaction from earlier
    const btn = document.getElementById('btn');
    const greet = document.getElementById('greet');
    if (btn) btn.addEventListener('click', () => { greet.textContent = 'Hello from the button!'; });
  </script>

  <!-- Supabase: load via ESM at the end so DOM exists -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // Your existing project details (anon key is safe for browser use with RLS)
    const SUPABASE_URL = 'https://sqavoppeqygatapxftom.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxYXZvcHBlcXlnYXRhcHhmdG9tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDczNzUsImV4cCI6MjA2OTg4MzM3NX0.GN9-8Q4wi77VUGeMUXKDyxplMai-J_AzWGtP0Fh6Yqo';

    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // HOME: show one message in the intro paragraph (old demo)
    async function loadIntro() {
      const el = document.getElementById('from-db');
      if (!el) return;
      const { data, error } = await supa.from('messages').select('text').order('id', { ascending: true }).limit(1).single();
      el.textContent = error ? ('Error: ' + error.message) : (data?.text ?? '(no message found)');
    }
    loadIntro();

    // MESSAGES: list latest, post new, subscribe realtime
    const list = document.getElementById('msg-list');
    const form = document.getElementById('msg-form');
    const input = document.getElementById('msg-input');

    function renderItem(row, where = 'end') {
      const li = document.createElement('li');
      const when = new Date(row.created_at ?? Date.now()).toLocaleString();
      li.innerHTML = `<strong>${escapeHtml(row.text)}</strong><br><small>${when}</small>`;
      if (where === 'start') list.prepend(li); else list.appendChild(li);
    }

    function escapeHtml(s = '') {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    async function loadMessages() {
      const { data, error } = await supa
        .from('messages')
        .select('id, text, created_at')
        .order('id', { ascending: false })
        .limit(50);

      list.innerHTML = '';
      if (error) { list.innerHTML = `<li>Error: ${escapeHtml(error.message)}</li>`; return; }
      if (!data || data.length === 0) { list.innerHTML = '<li class="muted">No messages yet.</li>'; return; }
      data.forEach(row => renderItem(row));
    }

    await loadMessages();

    // Post a new message (open insert policy required)
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = (input?.value ?? '').trim();
      if (!text) return;
      const { error } = await supa.from('messages').insert({ text });
      if (error) {
        alert('Insert failed: ' + error.message);
        return;
      }
      input.value = '';
      // We rely on realtime to show it instantly; as fallback we could prepend here too
    });

    // Realtime subscription for new messages
    supa
      .channel('public:messages')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
        renderItem(payload.new, 'start');
      })
      .subscribe();
  </script>
</body>
</html>
